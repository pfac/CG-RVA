<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<title>Basic Detector</title>
		<meta name="description" content="" />
		<meta name="author" content="RVA" />

		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		
		<script type="text/javascript" src="js/Three.js"></script>
		<script type="text/javascript" src="js/JSARToolKit.js"></script>
		<script type="text/javascript" src="camera.js"></script>
		<script type="text/javascript">
			threshold = 128;

			var arDetector;//	something to detect the markers
			var arMatResult;
			var arRaster;//		dunno...
			var cnvsVideo;//	cnvsAR holding the image from the video
			var cnvsAR;	//	dunno what this is for either
			var cntxtCnvsAR;//	dunno dafuq this is for
			var lastTime;//		saves the timestamp of the last rendered frame
			var texVideo;//	video texture???

			var markers;
			var tmp;

			var threeCamAR;
			var threeCamVideo;
			var threeRenderer;
			var threeScnAR;
			var threeScnVideo;

			var video;

			function detect () {
				if (video.ended)
					video.play();
				if (video.paused || window.paused)
					return;
				if (video.currentTime == video.duration)
					video.currentTime = 0;
				if (video.currentTime == lastTime)
					return;

				lastTime = video.currentTime;

				cnvsVideo.getContext("2d").drawImage(video, 0, 0, video.width, video.height);
				cnvsAR.getContext("2d").drawImage(video, 0, 0, video.width, video.height);
				
				var dt = new Date().getTime();

				cnvsAR.changed = true;
				texVideo.needsUpdate = true;

				var t = new Date();

				var detected = arDetector.detectMarkerLite(arRaster, threshold);
				//console.log(detected);

				for (var m = 0; m < detected; ++m) {
					var id = arDetector.getIdMarkerData(m);
					var currId;
					if (id.packetLength > 4) {
						currId = -1;
					} else {
						currId = 0;
						for (var i = 0; i < id.packetLength; ++i ) {
							currId = (currId << 8) | id.getPacketData(i);
						}
					}

					if (!markers[currId]) {
						markers[currId] = {};
					}

					arDetector.getTransformMatrix(m, arMatResult);
					markers[currId].age = 0;
					markers[currId].transform = Object.asCopy(arMatResult);
				}

				//	delete old markers
				for (var i in markers) {
					var r = markers[i];
					if (r.age > 1) {
						delete markers[i];
						threeScnAR.remove(r.model);
					}
					r.age++;
				}

				//	the cubes
				for (var i in markers) {
					var m = markers[i];
					if (!m.model) {
						m.model = new THREE.Object3D();
						var geometry = new THREE.CubeGeometry(100,100,100);
						// var material = new THREE.MeshLambertMaterial({color:0 | (0xffffff*Math.random())});
						var material = new THREE.MeshLambertMaterial({map:texVideo});
						// material.depthTest = false;
						// material.depthWrite = false;
						var cube = new THREE.Mesh(geometry, material);
						//cube.position.z = 100;
						cube.doubleSided = true;
						m.model.matrixAutoUpdate = false;
						m.model.add(cube);
						threeScnAR.add(m.model);
					}
					copyMatrix(m.transform, tmp);
					m.model.matrix.setFromArray(tmp);
					m.model.matrixWorldNeedsUpdate = true;
				}
				threeRenderer.autoClear = false;
				threeRenderer.clear();
				threeRenderer.getContext().clearColor(0.5, 0.5, 0.5, 1.0);
				threeRenderer.render(threeScnVideo, threeCamVideo);
				//threeRenderer.render(threeScnAR, threeCamAR);
			}

			window.onload = function() {
				video = document.createElement("video");
				video.width = 320;
				video.height = 240;
				video.loop = true;
				video.volume = 0;
				video.autoplay = true;
				video.controls = true;
					getUserMedia(video);
				document.body.appendChild(video);

				cnvsVideo = document.createElement("canvas");
				cnvsVideo.id = "cnvsVideo";
				cnvsVideo.width = video.width;
				cnvsVideo.height = video.height;
				document.body.appendChild(cnvsVideo);

				cnvsAR = document.createElement("canvas");
				cnvsAR.id = "cnvsAR";
				cnvsAR.width = cnvsVideo.width;
				cnvsAR.height = cnvsVideo.height;
				document.body.appendChild(cnvsAR);

				var dbgCnvsAR = document.createElement("canvas");
				dbgCnvsAR.id = 'dbgCnvsAR';
				dbgCnvsAR.width = cnvsAR.width;
				dbgCnvsAR.height = cnvsAR.height;
				document.body.appendChild(dbgCnvsAR);

				arRaster = new NyARRgbRaster_Canvas2D(cnvsAR);
				var param = new FLARParam(video.width,video.height);

				arMatResult = new NyARTransMatResult();

				arDetector = new FLARMultiIdMarkerDetector(param, 100);
				arDetector.setContinueMode(true);


				tmp = new Float32Array(16);

				threeRenderer = new THREE.WebGLRenderer();
				threeRenderer.setSize(320, 240);
				//threeRenderer.getContext().cullFace(threeRenderer.getContext().FRONT_AND_BACK);

				document.body.appendChild(threeRenderer.domElement);

				threeScnAR = new THREE.Scene();
				// var light = new THREE.PointLight(0xffffff);
				// light.position.set(400, 500, 100);
				// threeScnAR.add(light);
				// var light = new THREE.PointLight(0xffffff);
				// light.position.set(-400, -500, -100);
				// threeScnAR.add(light);

				var lghtAmbient = new THREE.AmbientLight(0xffffff);
				threeScnAR.add(lghtAmbient);

				// Create a threeCamAR and a marker root object for your Three.js threeScnAR.
				threeCamAR = new THREE.Camera();
				threeScnAR.add(threeCamAR);

				// Next we need to make the Three.js threeCamAR use the FLARParam matrix.
				param.copyCameraMatrix(tmp, 10, 10000);
				threeCamAR.projectionMatrix.setFromArray(tmp);



				threeScnVideo = new THREE.Scene();

				texVideo = new THREE.Texture(cnvsVideo);

				// Create threeScnAR and billboard for the video.
				var bbGeometry = new THREE.PlaneGeometry(2, 2, 0);
				var bbMaterial = new THREE.MeshBasicMaterial({map:texVideo});
				var billboard = new THREE.Mesh(bbGeometry, bbMaterial);
				billboard.material.depthTest = false;
				billboard.material.depthWrite = false;
				threeScnVideo.add(billboard)

				threeCamVideo = new THREE.Camera();

				threeScnVideo.add(threeCamVideo);

				markers = {};
				lastTime = 0;

				setInterval(detect, 15);
			}

			THREE.Matrix4.prototype.setFromArray = function(m) {
				return this.set(
					m[0], m[4], m[8], m[12],
					m[1], m[5], m[9], m[13],
					m[2], m[6], m[10], m[14],
					m[3], m[7], m[11], m[15]
				);
			};

			function copyMatrix(mat, cm) {
				cm[0] = mat.m00;
				cm[1] = -mat.m10;
				cm[2] = mat.m20;
				cm[3] = 0;
				cm[4] = mat.m01;
				cm[5] = -mat.m11;
				cm[6] = mat.m21;
				cm[7] = 0;
				cm[8] = -mat.m02;
				cm[9] = mat.m12;
				cm[10] = -mat.m22;
				cm[11] = 0;
				cm[12] = mat.m03;
				cm[13] = -mat.m13;
				cm[14] = mat.m23;
				cm[15] = 1;
			}
		</script>
	</head>

	<body>
	</body>
</html>
